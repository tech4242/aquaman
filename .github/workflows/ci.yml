name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libsecret-1-dev
      - name: Cache npm download cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            npm-${{ runner.os }}-
      - name: Install npm dependencies
        run: |
          rm -f package-lock.json
          npm install --legacy-peer-deps
      - run: npm run lint
      - run: npm run typecheck

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libsecret-1-dev
      - name: Cache npm download cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            npm-${{ runner.os }}-
      - name: Install npm dependencies
        run: |
          rm -f package-lock.json
          npm install --legacy-peer-deps
      - run: npm test

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libsecret-1-dev
      - name: Cache npm download cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            npm-${{ runner.os }}-
      - name: Install npm dependencies
        run: |
          rm -f package-lock.json
          npm install --legacy-peer-deps
      - run: npm run test:coverage
      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/lcov.info
          fail_ci_if_error: true

  e2e-openclaw:
    name: E2E OpenClaw Plugin
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libsecret-1-dev
      - name: Cache npm download cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            npm-${{ runner.os }}-
      - name: Install npm dependencies
        run: |
          rm -f package-lock.json
          npm install --legacy-peer-deps
      - name: Cache openclaw global install
        id: cache-openclaw
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/node_modules/openclaw
            /usr/local/bin/openclaw
          key: openclaw-${{ runner.os }}-node24-2026.2.15
      - name: Install openclaw
        if: steps.cache-openclaw.outputs.cache-hit != 'true'
        run: npm install -g openclaw@2026.2.15
      - run: npx vitest run test/e2e/openclaw-plugin.test.ts

      - name: Install plugin for security audit
        run: |
          rm -rf ~/.openclaw/extensions/aquaman-plugin
          mkdir -p ~/.openclaw/extensions/aquaman-plugin
          cp packages/plugin/index.ts ~/.openclaw/extensions/aquaman-plugin/
          cp packages/plugin/package.json ~/.openclaw/extensions/aquaman-plugin/
          cp packages/plugin/openclaw.plugin.json ~/.openclaw/extensions/aquaman-plugin/
          cp -r packages/plugin/src ~/.openclaw/extensions/aquaman-plugin/src
          cd ~/.openclaw/extensions/aquaman-plugin && npm install --omit=dev --silent

          # Write openclaw.json with plugin allowlist (but no tools.profile —
          # that's the operator's choice, not ours to impose)
          cat > ~/.openclaw/openclaw.json << 'EOF'
          {
            "plugins": {
              "allow": ["aquaman-plugin"],
              "entries": {
                "aquaman-plugin": {
                  "enabled": true,
                  "config": {
                    "backend": "encrypted-file",
                    "services": ["anthropic", "openai"]
                  }
                }
              }
            }
          }
          EOF

      - name: OpenClaw security audit
        run: |
          OUTPUT=$(openclaw security audit --deep 2>&1) || true
          echo "$OUTPUT"

          # Filter to aquaman-plugin findings only
          AQUAMAN_FINDINGS=$(echo "$OUTPUT" | grep -i "aquaman-plugin" || true)

          if [ -z "$AQUAMAN_FINDINGS" ]; then
            echo "No aquaman-plugin findings"
            exit 0
          fi

          # Expected findings (not aquaman code issues):
          # 1. dangerous-exec on proxy-manager.ts — true positive, plugin spawns proxy process
          # 2. tools_reachable_permissive_policy — environment advisory, not a code vulnerability;
          #    operator chooses their own tools.profile, aquaman should not force "coding" mode
          UNEXPECTED=$(echo "$AQUAMAN_FINDINGS" \
            | grep -v -e "dangerous-exec.*proxy-manager" \
            | grep -v -e "code_safety.*dangerous code patterns" \
            | grep -v -e "tools_reachable_permissive_policy" \
            | grep -v -e "Enabled extension plugins:" \
            | grep -v -e "permissive tool policy" \
            || true)

          if [ -n "$UNEXPECTED" ]; then
            echo "UNEXPECTED scanner findings:"
            echo "$UNEXPECTED"
            exit 1
          fi

          echo "Only expected findings: dangerous-exec on proxy-manager.ts, tools_reachable_permissive_policy (env advisory)"
